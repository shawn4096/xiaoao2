//taoma.c
//
//by sohu
//绕鞭子成圆，套向对方

#include <ansi.h>

inherit F_SSERVER;

int perform(object me, object target)
{
	string msg;
	int i;
	object weapon = me->query_temp("weapon");

	if( !target ) target = offensive_target(me);

	if( !objectp(target)
	|| !target->is_character()
	|| !me->is_fighting(target) )
		return notify_fail("套马绝技只能对战斗中的对手使用。\n");

	if(me->query_skill("jinlong-bianfa",1) < 150)
		return notify_fail("你的「金龙鞭法」还不够娴熟，不会使用套马绝技。\n");
	if(me->query_skill("whip",1) < 150)
		return notify_fail("你的「基本鞭法」还不够娴熟，不会使用套马绝技。\n");
	if( !weapon 
		|| weapon->query("skill_type") != "whip"
		|| me->query_skill_mapped("whip") != "jinlong-bianfa" 
		|| me->query_skill_mapped("parry") != "jinlong-bianfa" ) 
		return notify_fail("你现在无法使用套马绝技。\n");

	if( me->query("neili") < 500 )
		return notify_fail("你的内力不够500。\n");
	if( me->query("jingli") < 500 )
		return notify_fail("你的精力不够500。\n");

	if( me->query("max_neili") < 1500 )
		return notify_fail("你的最大内力不够1500。\n");
	if( me->query("max_jingli") < 1300 )
		return notify_fail("你的最大内力不够1300。\n");
	if( target->is_busy() )
		return notify_fail(target->name() + "目前正自顾不暇，放胆攻击吧。\n");
	
	message_vision(HIW "\n$N忽然将手中的"+weapon->query("name")+HIW"使出「金龙鞭法」的套马绝技的功夫，形成一个圆圈套向$n！\n"NOR,me,target);

	if(random(me->query("combat_exp") )> target->query("combat_exp")/i
		||random(me->query_dex(1)) > target->query_dex(1)/i)
	{
		message_vision(HIY "\n结果$p被$P一卷，套住脖子，顿时天旋地转。\n" NOR,me,target);
		target->add_busy((int)me->query_skill("jinlong-bianfa",1)/100);
		target->apply_condition("no_exert",1);
		target->receive_damage("qi",3000,me);
	}
	else {
		message_vision(HIW "可是$p看破了$P的套马绝技，身子一跃便躲开了。\n" NOR,me,target);
		me->start_perform(2,"套马绝技");
		me->add_busy(1);
	}
	//message_vision(msg, me, target);

	me->add("jingli", -100);
	me->add("neili", -200);
    return 1;
}

string perform_name(){ return HIW"套马绝技"NOR; }

int help(object me)
{
        write(HIG"\n金龙鞭法之「套马绝技」："NOR"\n\n");
        write(@HELP
	「金龙鞭法」是江南七怪韩宝驹的独门武技，韩宝驹一生
	爱马，所以将金龙鞭法往往化作套马索，既能套住烈马，
	也可以以此技伤人。
    
	指令：perform whip.taoma
		
要求：  
	当前内力需求 500 以上；
	最大内力需求 1500 以上；
	当前精力需求 500 以上；
	最大精力需求 1300 以上；
	当前精力需求 500 以上；
	金龙鞭法等级 150 以上；
	基本鞭法等级 150 以上:
	激发鞭法为金龙鞭法；
	激发招架为金龙鞭法；
	且手持鞭子类兵器。

HELP
        );
        return 1;
}
